#!/usr/bin/env bash
# copilot-usage - Show GitHub Copilot premium request usage for tmux status bar
#
# Uses the same internal API as VS Code to get accurate quota numbers.
# Requires: gh CLI authenticated (gh auth login)

set -euo pipefail

CACHE_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/copilot-usage-cache.json"
CACHE_TTL=5 # 5 seconds for real-time updates

# --- Check cache ---
if [[ -f "$CACHE_FILE" ]]; then
  CACHE_MOD=$(stat -f %m "$CACHE_FILE" 2>/dev/null || stat -c %Y "$CACHE_FILE" 2>/dev/null || echo 0)
  NOW=$(date +%s)
  if (( NOW - CACHE_MOD < CACHE_TTL )); then
    cat "$CACHE_FILE"
    exit 0
  fi
fi

# --- Get gh token ---
TOKEN=$(gh auth token 2>/dev/null) || {
  echo "no gh"
  exit 0
}

# --- Fetch usage from internal API ---
RESPONSE=$(curl -sS --max-time 10 \
  "https://api.github.com/copilot_internal/user" \
  -H "Authorization: token $TOKEN" \
  -H "Editor-Version: vscode/1.107.0" \
  -H "Editor-Plugin-Version: copilot-chat/0.35.0" \
  -H "User-Agent: GitHubCopilotChat/0.35.0" \
  -H "Accept: application/json" 2>/dev/null) || {
  [[ -f "$CACHE_FILE" ]] && cat "$CACHE_FILE"
  exit 0
}

# --- Parse quota ---
OUTPUT=$(echo "$RESPONSE" | jq -r '
  .quota_snapshots.premium_interactions // empty
  | if .unlimited then "unlimited"
    else
      ((100 - .percent_remaining) | . * 10 | round | . / 10 | tostring) + "%"
    end
' 2>/dev/null) || {
  [[ -f "$CACHE_FILE" ]] && cat "$CACHE_FILE" || echo "err"
  exit 0
}

if [[ -z "$OUTPUT" ]]; then
  echo "n/a"
  exit 0
fi

# --- Cache & output ---
mkdir -p "$(dirname "$CACHE_FILE")"
printf '%s' "$OUTPUT" > "$CACHE_FILE"
printf '%s' "$OUTPUT"
